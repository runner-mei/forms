{{- define "main"}}

    {{- $isEditable := false}}
    {{- $ctx_parent := $.ctx_parent}}
    {{- if $ctx_parent.ctx_parent}}
      {{- $ctx_parent = $ctx_parent.ctx_parent}}
    {{- end}}
    {{- range .classes}}
      {{- if eq . "bar-rating" }}
        {{- append $ctx_parent "moreScripts" "/public/js/plugins/barrating/jquery.barrating.min.js" -}}
        {{- append $ctx_parent "moreLazyStyles" "/public/css/plugins/barrating/fontawesome-stars.css" -}}
        {{- unique $ctx_parent "moreScripts" -}}
        {{- unique $ctx_parent "moreLazyStyles" -}}
      {{- end -}}
      {{- if eq . "chosen" }}
        {{- append $ctx_parent "moreScripts" "/public/js/plugins/chosen/chosen.jquery.js" -}}
        {{- append $ctx_parent "moreLazyStyles" "/public/css/plugins/chosen/chosen.css" -}}
        {{- unique $ctx_parent "moreScripts" -}}
        {{- unique $ctx_parent "moreLazyStyles" -}}
      {{- end -}}
      {{- if eq . "select2" }}
        {{- append $ctx_parent "moreScripts" "/public/js/plugins/select2/select2.full.min.js" -}}
        {{- append $ctx_parent "moreLazyStyles" "/public/css/plugins/select2/select2.min.css" -}}
        {{- unique $ctx_parent "moreScripts" -}}
        {{- unique $ctx_parent "moreLazyStyles" -}}
      {{- end -}}
      {{- if eq . "editable-select" }}
        {{- $isEditable = true}}
        {{- append $ctx_parent "moreScripts" "/public/js/plugins/jquery-editable-select/jquery-editable-select.min.js" -}}
        {{- append $ctx_parent "moreLazyStyles" "/public/css/plugins/jquery-editable-select/jquery-editable-select.min.css" -}}
        {{- unique $ctx_parent "moreScripts" -}}
        {{- unique $ctx_parent "moreLazyStyles" -}}
      {{- end -}}
    {{- end}}

    {{- if .preText}}<span>{{.preText}}</span>{{end -}}
    <select name="{{.name}}" class="form-control {{ if .classes }}{{range .classes}}{{.}} {{end}}{{end}}"
            {{- if .id}} id="{{.id}}" {{end}}{{if .params}}{{range $k, $v :=.params}} {{$k}}="{{$v}}" {{end}}{{end -}}
            {{- if .css}}
            style="{{range $k, $v := .css}}{{$k}}: {{$v}}; {{end}}"
            {{- end -}}
            {{- range $v :=.tags}} {{$v}}{{end}}>

      {{- $valueExists := false}}
      {{- $p := . -}}
      {{- range $v := .choices -}}
        {{- if $v.Label -}}
        <optgroup label="{{$v.Label}}">
        {{- end -}}

        {{- range $v.Children -}}
        <option value="{{.Value}}"
                {{- if strIn "multiple" $p.tags -}}
                  {{- $id :=.Value -}}
                  {{- range $k2, $p2 :=$p.multValues -}}
                    {{- if eq $k2 $id}}selected {{- $valueExists = true -}}{{end -}}
                  {{- end -}}
                {{- else -}}
                  {{- if eq $p.value .Value}} selected {{- $valueExists = true -}} {{end -}}
                {{- end}}>{{raw .Label -}}
        </option>
        {{- end -}}
        
        {{- if $v.Label -}}
        </optgroup>
        {{- end -}}
      {{- end -}}

      {{- if and $isEditable (not $valueExists) }}
        {{- if strIn "multiple" $p.tags -}}
          {{- range $k2, $p2 :=$p.multValues -}}
          <option value="{{$k2}}" selected> {{$k2}} </option>
          {{- end -}}
        {{- else -}}
          <option value="{{$p.value}}" selected> {{$p.value}} </option>
        {{- end -}}
      {{- end -}}

    </select>
    {{- if .postText}}<span>{{.postText}}</span>{{end -}}

    {{- if or .helptext .errors }}<span class="help-block">{{if .helptext}}{{ .helptext }}{{end -}}
    {{- if .errors}}<ul>{{ range .errors }}<li>{{.}}</li>{{end}}</ul>{{end}}</span>{{end -}}



    {{- range .classes}}
        {{- if eq .  "chosen" }}
        {{-   if not $ctx_parent.___hasChosen___ -}}
        {{-     set $ctx_parent "___hasChosen___" true -}}
        <script>
          if (tpt_form_callbacks == null) {
            tpt_form_callbacks = new Array();
          }
          tpt_form_callbacks.push(function () {
              $(function () {
                  if (typeof $.fn.chosen !== "undefined"){
                    $(".chosen").each(function(){
                      var disabled = $(this).attr("readonly") === "readonly";
                      $(this).prop("disabled", disabled).chosen({search_contains:true,width:'100%',disabled:disabled});
                    })
                  }
              });
            });
        </script>
        {{-   end -}}
        {{- end -}}


        {{- if eq .  "select2" }}
        {{-   if not $ctx_parent.___hasSelect2___ -}}
        {{-     set $ctx_parent "___hasSelect2___" true -}}
        <script>
          if (tpt_form_callbacks == null) {
            tpt_form_callbacks = new Array();
          }
          tpt_form_callbacks.push(function () {
              $(function () {
                  if (typeof $.fn.select2 !== "undefined"){
                    $(".select2").each(function(){
                      var disabled = $(this).attr("readonly") === "readonly";
                      $(this).prop("disabled", disabled).select2({
                        // search_contains:true,
                        width:'100%',
                        disabled:disabled});
                    })
                  }
              });
            });
        </script>
        {{-   end -}}
        {{- end -}}
    

        {{-   if eq . "bar-rating" }}
        {{-     if not $ctx_parent.___hasBarRating___ -}}
        {{-        set $ctx_parent "___hasBarRating___" true -}}
        <script type="text/javascript">
          if (tpt_form_callbacks == null) {
            tpt_form_callbacks = new Array();
          }
          tpt_form_callbacks.push(function () {
              $(function () {
                  $('.bar-rating').barrating({
                    theme: 'fontawesome-stars'
                  });
              });
            });
        </script>
        {{-     end -}}
        {{-   end -}}


        {{-   if eq . "editable-select" }}
        {{-     if not $ctx_parent.___hasEditable___ -}}
        {{-        set $ctx_parent "___hasEditable___" true -}}
        <script type="text/javascript">
          if (tpt_form_callbacks == null) {
            tpt_form_callbacks = new Array();
          }
          tpt_form_callbacks.push(function () {
              $(function () {
                  $('.editable-select').editableSelect();
              });
            });
        </script>
        {{-     end -}}
        {{-   end -}}
    {{- end -}}

{{- end}}
